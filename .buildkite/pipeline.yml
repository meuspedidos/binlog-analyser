steps:

  - command: |-
      echo "~~~ pip2 install"
      echo 'odus' | sudo -S rm -rf /tmp/pip_build_root/*
      echo 'odus' | sudo -S pip2 install -r requirements.txt

      echo "~~~ test app"
      python -m unittest discover tests

    label: application test
    agents:
      - type=native

  - command: |-
      echo "~~~ pip2 install"
      echo 'odus' | sudo -S rm -rf /tmp/pip_build_root/*
      echo 'odus' | sudo -S pip2 install -r requirements.txt

      echo '~~~ update pip2'
      python -m pip2 install --upgrade pip2 setuptools wheel
      hash -r pip2
      hash -d pip2

      echo "~~~ building dist"
      rm -rf dist/*
      python setup.py sdist

      echo "~~~ testing dist"
      version=$(cat binlogexplorer/version)
      pip2 --version
      pip2 uninstall mysql-binlog-explorer -y || true
      pip2 install dist/mysql-binlog-explorer-${version}.tar.gz --no-cache-dir
      mysql-binlog-explorer -h

    label: package distribution test
    agents:
      - type=native

  - wait

  - command: |-
      echo "~~~ pip2 install"
      echo 'odus' | sudo -S rm -rf /tmp/pip_build_root/*
      echo 'odus' | sudo -S pip2 install -r requirements_ci.txt

      echo '~~~ update pip2'
      python -m pip2 install --upgrade pip2 setuptools wheel

      echo "~~~ cleaning"
      rm -rf dist

      echo "~~~ publishing"
      ./publish.sh

    label: publish
    branches: master
    agents:
      - type=native
    concurrency: 1
    concurrency_group: 'mysql-binlog-explorer-deploy'
